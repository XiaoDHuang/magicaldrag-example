function Table(){this.api=new MagicalApi();this.methodPrefix="magicalcoder";this.methodReg=new RegExp("^"+this.methodPrefix+"(\\d*)(\\(?(.*)\\)?)");this.methodNameReg=new RegExp("^"+this.methodPrefix+"\\d*")}Table.prototype.dbFieldSelectConfig=function(a){var c=[];for(var d=0;d<a.length;d++){var f=a[d];var e={};e[f.name]=f.comment;c.push(e)}var b={type:"select",clearAttr:true,oneLine:true,change:"attr",title:"绑定数据库字段名",attrName:"v-model",options:c};return b};Table.prototype.pubFindFromRightPanel=function(b,h){var g=[];var e=this.api.getConstant().rightPanel;for(var c=0;c<e.length;c++){var d=e[c];var f=d.content[b];if(f){for(var a=0;a<f.length;a++){if(this.matchQueryMap(f[a],h)){g.push(f[a])}}}}return g};Table.prototype.matchQueryMap=function(b,c){if(c==null){return true}var d=true;for(var a in c){if(b[a]!=c[a]){d=false;break}}return d};Table.prototype.numMethodId=function(b){if(this.methodReg.test(b)){this.methodReg.exec(b);var a=RegExp.$1;return a}return""};Table.prototype.strMethodName=function(a){var b=this.methodPrefix+a;return b};Table.prototype.isMagicalDynamicStrMethodName=function(a){return this.methodReg.test(a)};Table.prototype.replaceMethodNameArea=function(b,a){return b.replace(this.methodNameReg,this.strMethodName(a))};Table.prototype.findMethodParams=function(a){var c=[];if(this.methodReg.test(a)){this.methodReg.exec(a);var b=RegExp.$2;if(b){b=b.replace("(","").replace(")","");if(b.trim()==""){return[]}return b.split(/[,，]/)}}return c};function PageRebuildConstant(a){this.api=a;this.lowCodeConstant=new LowCodeConstant();this.lowCodeUtil=new LowCodeUtil();this.constant=a.getConstant()}PageRebuildConstant.prototype.pubReplace=function(){this.priReplaceRightConfig()};PageRebuildConstant.prototype.priReplaceRightConfig=function(){var e=this.api.getConstant().getRightPanel();for(var d=0;d<e.length;d++){var f=e[d].content;for(var c in f){var g=f[c];for(var b=0;b<g.length;b++){var a=g[b];if(",el-table,el-form,".indexOf(c)!=-1){if(a.attrName=="mc-form-data"){this.priSetFormListOptions(a)}}}}}};PageRebuildConstant.prototype.priSetFormListOptions=function(a){$.getJSON(commonUtil.ctx+"deployer/db/all_table_list/",{date:new Date().getTime()},function(f){if(f.flag){var e=f.data;if(e){var b=[];for(var c=0;c<e.length;c++){var d=e[c];b.push(d)}a.options=b}}else{layer.msg(f.desc)}})};PageRebuildConstant.prototype.pubReplaceFunction=function(a){this.scopeTemplate(a)};PageRebuildConstant.prototype.scopeTemplate=function(d){var b=d.magicalCoder.identifier;if(b=="el-table-column"||b=="template"||b=="root"||b=="el-table"){return}this.resetDefaultFunctionsParams(d);var a=this.api.getRootNode();var c=this.lowCodeUtil.nodeUtil.nodeToMap(a);this.dealElTableColumn(c,d)};PageRebuildConstant.prototype.dealElTableColumn=function(d,e){var c=e;var b=e.magicalCoder.identifier;while(true){var f=c.magicalCoder.parentId;if(!f){break}var a=d[f];if(!a||a.magicalCoder.identifier=="root"){break}if(a.magicalCoder.identifier=="el-table-column"){switch(b){case"el-switch":this.privateResetConfig(b,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"采用scope.row.字段名",}]);break;case"el-radio-group":this.privateResetConfig(b,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"采用scope.row.字段名",}]);break;case"el-checkbox-group":this.privateResetConfig(b,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"采用scope.row.字段名",}]);break;case"el-input":this.privateResetConfig(b,[{compareAttrName:"@blur",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"@focus",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"@clear",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"采用scope.row.字段名",}]);break;case"el-select":this.privateResetConfig(b,[{compareAttrName:"@blur",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"@clear",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"采用scope.row.字段名",}]);break;case"el-slider":this.privateResetConfig(b,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"@input",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"采用scope.row.字段名",}]);break;case"el-date-picker":this.privateResetConfig(b,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"@blur",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"@focus",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"采用scope.row.字段名",}]);break;case"el-rate":this.privateResetConfig(b,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"采用scope.row.字段名",}]);break;case"el-color-picker":this.privateResetConfig(b,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"@active-change",setAttrName:"functionParams",setValue:[{attrParamName:"scope.row",name:"_param1",title:"当前行数据"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"采用scope.row.字段名",}]);break}break}c=a}};PageRebuildConstant.prototype.resetDefaultFunctionsParams=function(b){var a=b.magicalCoder.identifier;switch(a){case"el-switch":this.privateResetConfig(a,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"开关新值"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",}]);break;case"el-radio-group":this.privateResetConfig(a,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前选中的值"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",}]);break;case"el-checkbox-group":this.privateResetConfig(a,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前选中的值"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",}]);break;case"el-input":this.privateResetConfig(a,[{compareAttrName:"@blur",setAttrName:"functionParams",setValue:[{name:"e",title:"event"}],},{compareAttrName:"@focus",setAttrName:"functionParams",setValue:[{name:"e",title:"event"}],},{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前选中的值"}],},{compareAttrName:"@clear",setAttrName:"functionParams",setValue:[{name:"e",title:"event"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",}]);break;case"el-input-number":this.privateResetConfig(a,[{compareAttrName:"@blur",setAttrName:"functionParams",setValue:[{name:"e",title:"event"}],},{compareAttrName:"@focus",setAttrName:"functionParams",setValue:[{name:"e",title:"event"}],},{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._inputNumberValue,title:"当前的值"},{name:commonUtil.functionName._oldInputNumberValue,title:"旧的值"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",}]);break;case"el-select":this.privateResetConfig(a,[{compareAttrName:"@focus",setAttrName:"functionParams",setValue:[{name:"e",title:"event"}],},{compareAttrName:"@blur",setAttrName:"functionParams",setValue:[{name:"e",title:"event"}],},{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前选中的值"}],},{compareAttrName:"@clear",setAttrName:"functionParams",setValue:null,},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",},{compareAttrName:":remote-method",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._keywordValue,title:"查询关键词"}],}]);break;case"el-slider":this.privateResetConfig(a,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前的值"}],},{compareAttrName:"@input",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前的值"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",}]);break;case"el-date-picker":this.privateResetConfig(a,[{compareAttrName:"@blur",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前实例"}],},{compareAttrName:"@focus",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前实例"}],},{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前的值"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",}]);break;case"el-rate":this.privateResetConfig(a,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"改变后的分值"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",}]);break;case"el-color-picker":this.privateResetConfig(a,[{compareAttrName:"@change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前值"}],},{compareAttrName:"@active-change",setAttrName:"functionParams",setValue:[{name:commonUtil.functionName._currentValue,title:"当前显示的颜色值"}],},{compareAttrName:"v-model",setAttrName:"placeholder",setValue:"字段名",}]);break}};PageRebuildConstant.prototype.privateResetConfig=function(c,g){var e=this.constant.getRightConfig(c);if(e&&e.length>0){for(var d=0;d<e.length;d++){var a=e[d];for(var f=0;f<g.length;f++){var b=g[f];if(a.attrName==b.compareAttrName){a[b.setAttrName]=b.setValue}}}}};function PageRightCallback(a){this.api=a;this.constant=this.api.getConstant();this.lowCodeConstant=new LowCodeConstant();this.lowCodeUtil=new LowCodeUtil()}PageRightCallback.prototype.changeTableByMcFormData=function(c){if(c.changeAttrValue){var b=this;var a=c.focusNode.magicalCoder.identifier;if(a=="el-table"){$.getJSON(commonUtil.ctx+"deployer/db/table_info/construct/"+c.changeAttrValue,{data:new Date().getTime()},function(g){if(g.flag){if(g.data){var e=JSON.parse(g.data.formTableConstruct);var f=b.tableHtml(e);var d=b.api.htmlToRootNode(f).magicalCoder.children;b.api.resetChildren(c.focusNode.magicalCoder.id,d)}}})}else{if(a=="el-form"){$.getJSON(commonUtil.ctx+"deployer/db/table_info/form_data/"+c.changeAttrValue,{data:new Date().getTime()},function(g){if(g.flag){if(g.data){var d=b.api.htmlToRootNode(g.data.formHtml).magicalCoder.children;var j=[];if(d){for(var f=0;f<d.length;f++){var h=d[f];if(h.magicalCoder.identifier=="el-form"){b.lowCodeUtil.arrayUtil.copyArray(j,h.magicalCoder.children)}}}var e=b.api.htmlToRootNode(b.formOperateHtml()).magicalCoder.children;b.lowCodeUtil.arrayUtil.copyArray(j,e);b.api.resetChildren(c.focusNode.magicalCoder.id,j)}}})}}}};PageRightCallback.prototype.tableHtml=function(b,g,e){var d=[];if(b){for(var c=0;c<b.length;c++){var f=b[c];if(f.identifier!="el-upload"){if(f.dbType=="bool"){d.push('<el-table-column label="'+f.comment+'"><template slot-scope="scope"><el-switch v-model="scope.row.'+f.name+'" disabled></el-switch></template></el-table-column>')}else{d.push('<el-table-column prop="'+f.name+'" label="'+f.comment+'"></el-table-column>')}}}}var a='<el-table-column label="操作" fixed="right" width="200px"><template slot-scope="scope"><el-button mc-type="column-el-button" size="mini" type="primary" '+(g||"")+'>编辑</el-button><el-button mc-type="column-el-button" size="mini" type="danger" '+(e||"")+">删除</el-button></template></el-table-column>";d.push(a);return d.join("")};PageRightCallback.prototype.formOperateHtml=function(){return"<el-form-item><el-button>提交</el-button></el-form-item>"};function ExtendHrefParams(a){this.paramList=a}ExtendHrefParams.prototype.render=function(){var a=this;$("._pageParamAdd").click(function(){a.addLine()});$("._pageParamDelete").click(function(){$(this).parent().parent().parent().remove()})};ExtendHrefParams.prototype.addLine=function(){$("._pageParamRow").append($(this.lineTemplate({name:"",value:""})));$("._pageParamDelete").click(function(){$(this).parent().parent().parent().remove()})};ExtendHrefParams.prototype.template=function(){var c='<div class="layui-row layui-col-space10" style="padding:20px 20px 0px 20px;width: 95%;">\n    <div class=" layui-col-xs12">\n        <a class="layui-btn layui-btn-normal _pageParamAdd" style="margin-bottom: 4px;">新增</a>\n    </div>\n    <div class=" layui-col-xs5">\n        参数名\n    </div>\n    <div class=" layui-col-xs5">\n        测试参数:开发中可动态传参此值便无效\n    </div>\n    <div class=" layui-col-xs2">\n        操作\n    </div>\n</div>';var d=[];if(this.paramList){for(var b=0;b<this.paramList.length;b++){d.push(this.lineTemplate(this.paramList[b]))}}var a='<div class="layui-row layui-col-space10 _pageParamRow" style="padding:20px;width: 95%;">'+d.join("")+"</div>";return c+a};ExtendHrefParams.prototype.lineTemplate=function(a){return'<div class="layui-col-xs12"><div class="layui-row layui-col-space10">\n            <div class=" layui-col-xs5">\n                <input class="layui-input _paramName" type="text" autocomplete="off" value="'+a.name+'"/>\n            </div>\n            <div class=" layui-col-xs5">\n                <input class="layui-input _paramValue" type="text" autocomplete="off" value="'+a.value+'"/>\n            </div>\n            <div class=" layui-col-xs2">\n                <a class="layui-btn layui-btn-sm layui-btn-danger _pageParamDelete">删除</a>\n            </div>\n        </div></div>\n'};ExtendHrefParams.prototype.getData=function(){var c=[];var b=$("._pageParamRow").children();if(b.length>0){for(var e=0;e<b.length;e++){var a=$(b[e]);var d=a.find("._paramName").val();var f=a.find("._paramValue").val();if(d){c.push({name:d,value:f})}}}return c};function Page(){this.iframeUi=null;this.pageId=commonUtil.getParameter("pageId");this.api=null;this.projectId=null;this.tableUtil=new Table();this.lowCodeConstant=new LowCodeConstant();this.lowCodeUtil=new LowCodeUtil();this.rightCallback=null;this.rebuildConstant=null;this.pageAjax=new PageAjax()}Page.prototype.inject=function(a){this.api=a;this.iframeUi=a.getIframeUi();this.rightCallback=new PageRightCallback(a);this.rebuildConstant=new PageRebuildConstant(a)};Page.prototype.initVueMethods=function(e,c){var g=this;var b={priSearch:function(k,o){var r=o.magicalCoder.identifier;var v=g.tableUtil.pubFindFromRightPanel(r,{extendKey:"method"});var p=o.attributes;if(v.length>0){for(var l=0;l<v.length;l++){var m=v[l];var s=m.attrName;var u=p[s];if(g.tableUtil.isMagicalDynamicStrMethodName(u)){var t=g.tableUtil.numMethodId(u);if(t){k[t]=u;if(g.isMcWindowOnloadMethod(r,m)){g.iframeUi.vueMountedMethodName=u}}}}}var j=o.magicalCoder.children;if(j.length>0){for(var q=0;q<j.length;q++){this.priSearch(k,j[q])}}}};var h={};var d=e.htmlToRootNode(c);b.priSearch(h,d);var f=[];for(var a in h){f.push(a)}if(f.length>0){page.pageAjax.initPageDependOnMethods(f,function(m){for(var k=0;k<m.length;k++){var o=m[k];var n=o.id;var l=o.functionJs||"function(){}";var j=e.getIframeUi().getMethods();j[g.tableUtil.strMethodName(n)]=l}e.refreshWorkspace()})}};Page.prototype.isMcWindowOnloadMethod=function(b,a){if(b=="mc-window"&&a.extendKey=="method"&&a.attrName=="onload"){return true}return false};var page=new Page();MagicalCallback.prototype.after_start=function(a){page.inject(a);page.rebuildConstant.pubReplace();page.pageAjax.initPageData(page.pageId,function(c,b,d){a.insert(c,b);page.projectId=d;$("#returnToMyPageList").attr("href","../lowcode/page/list.html?projectId="+d);page.initVueMethods(a,c)})};MagicalCallback.prototype.save_html=function(c,b,a){var d={id:page.pageId,pageHtml:c,pageJs:a};page.pageAjax.savePageData(d,function(){window.location.href="../lowcode/page/list.html?projectId="+page.projectId})};MagicalCallback.prototype.extend_config=function(j,a,d,c,m){if(d.extendKey=="icon"){var h="";if(j==0){h="iframe-layui-2.5.4.html"}else{if(j==4){h="iframe-element-2.10.1.html"}}var g=layer.open({type:2,content:h+"?from=icon_list",title:"扩展编辑",area:["800px","600px"],maxmin:true,btn:["确定"],yes:function(){var o=d.attrName;var r=$("#layui-layer-iframe"+g).contents();var q=r.find(".magicalcoder-extend-icons").find("i.active").first();var p="";if(j==0){var s=q.length>0?q.attr("class").replace("active","").replace("layui-icon","").trim():"";var t=c.attributes[o]||"";if(t.indexOf("layui-icon-")!=-1){p=t.replace(/layui-icon-[-\w]+/g,s)}else{p=t+" "+s}}else{if(j==4){var s=q.length>0?q.attr("class").replace("active","").trim():"";var t=c.attributes[o]||"";if(t.indexOf("el-icon-")!=-1){p=t.replace(/el-icon-[-\w]+/g,s)}else{p=t+" "+s}}}p=p.trim();a.val(p);m(o,p);layer.close(g)},cancel:function(p,o){}})}else{if(d.extendKey=="method"){var i=d.attrName;var k=c.attributes[i];var b=page.pageId||"";var f=page.tableUtil.findMethodParams(k);window.pageParams={api:page.api,rootNode:page.api.getRootNode(),focusNode:c,iframeUi:page.iframeUi,extra:{attrName:i,attrValue:k,pageId:b,methodParams:f},rightPanelItemObj:d};var g=layer.open({type:2,content:"index-code.html",title:"定制动作事件",area:["1000px","800px"],maxmin:true,moveOut:true,shade:false,btn:["关闭"],yes:function(){page.api.refreshWorkspace();a.val(c.attributes[i]);layer.close(g)},cancel:function(p,o){a.val(c.attributes[i]);page.api.refreshWorkspace()}});layer.full(g)}else{if(d.extendKey=="params"){var i=d.attrName;var e=c.attributes[i]||"";var n=[];if(e){n=JSON.parse(page.lowCodeUtil.xssUtil.unEscapeXss(e))}var l=new ExtendHrefParams(n);var g=layer.open({type:1,content:l.template(),title:"扩展编辑",area:["800px","600px"],maxmin:true,btn:["确定"],yes:function(){var p=l.getData();var o=JSON.stringify(p);a.val(o);m(i,page.lowCodeUtil.xssUtil.escapeXss(o));layer.close(g)},cancel:function(p,o){}});l.render()}}}};MagicalCallback.prototype.before_change_attr_callback=function(c){var d=c.changeAttrName;var a=c.changeAttrValue;if(c.itemObj.validate){var b=page.lowCodeUtil.mapUtil.coverToKeyValue(c.itemObj.validate);if(b.key=="^[a-zA-Z][a-zA-Z0-9_]*$"){if(page.lowCodeConstant.jsKeepName.indexOf(","+a+",")!=-1){layer.msg(a+"是保留关键字,请换个名字吧");return false}}}return true};MagicalCallback.prototype.after_change_attr_callback=function(d){var b=d.focusNode.magicalCoder.identifier;var e=d.changeAttrName;var a=d.changeAttrValue;if(b=="mc-window"){if(e=="onload"){page.iframeUi.vueMountedMethodName=d.changeAttrValue}}else{if(b=="el-upload"){if(e==":file-list"){d.focusNode.attributes.ref=d.changeAttrValue}}else{if(b=="el-table"||b=="el-form"){if(e=="mc-form-data"){page.rightCallback.changeTableByMcFormData(d)}}else{if(b=="el-date-picker"){if(e=="type"){switch(a){case"year":d.focusNode.attributes.format="yyyy";break;case"month":d.focusNode.attributes.format="yyyy-MM";break;case"date":d.focusNode.attributes.format="yyyy-MM-dd";break;case"datetime":d.focusNode.attributes.format="yyyy-MM-dd HH:mm:ss";break}page.api.refreshWorkspace()}}}}}if(e.startsWith(":")){var c=d.focusNode.attributes[e.substr(1)];if(c){delete d.focusNode.attributes[e.substr(1)];page.api.refreshRightAttrPane([d.focusNode.magicalCoder.id]);page.api.refreshWorkspace()}}else{var c=d.focusNode.attributes[":"+e];if(c){delete d.focusNode.attributes[":"+e];page.api.refreshRightAttrPane([d.focusNode.magicalCoder.id]);page.api.refreshWorkspace()}}};MagicalCallback.prototype.reset_before=function(){page.iframeUi.resetMethods();page.iframeUi.resetVueMountedMethodName()};MagicalCallback.prototype.pre_build_attrs=function(a){page.rebuildConstant.pubReplaceFunction(a);return true};